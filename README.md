# Microservice
Generated by serverless-leo

# Goals
1) Serverless framework
2) Bot Pipe version
3) Bot Async Pipe version
4) Deployable
5) Config
	ENV
	Secrets
6) Triggers
	Cron
	Event
7) Testable
	Per Bot local testing
	Breakpoints

Stretch
Sdkless bot
Chainable Bot Testing


# Setup

# 1) Create Microservice
serverless create --template-url https://github.com/LeoPlatform/serverless-leo/tree/master/templates/microservice -p rstreams-example
Edit version of leo-sdk to be `5.0.19-beta.6`
npm install

# 1.2) Fix config files
Remove .tsconfig output dir
Remove serverless-webpack

# 2) Create Loader Bot
serverless create bot --name weather-loader

# 3) Added an event (serverless-leo doesn't support non event code) // TODO: Fix this
weather-loader/serverless.yml
  events:
    - leo:
        cron: 0 */1 * * * * 

# 4) Write bot code
see weather-loader/index.ts

# 5) Setup Environment Vars
npm i cross-env-file
create file .env.local.json
add RStreams Config to the env file

# 5.1) Environment Vars for cloud
add cloudformation/parameters.yml


# 6) Invoke bot locally
 tsc && cross-env-file -p ./.env.local.json serverless invoke-bot -s test -f "weather-loader"
 serverless invoke-bot --stage dev -f "weather-loader"

# Add another bot
serverless create bot --name weather-processor

# Add Event to the bot
  events:
    - leo:
        source: rstreams-example.weather
        destination: rstreams-example.weather-transformed

# Invoke bot locally
 tsc && cross-env-file -p ./.env.local.json serverless invoke-bot -s test -f "weather-processor"
 npx serverless invoke-bot --stage dev -f "weather-processor"
  --  must use --stage instead of -s because useDotenv doesn't use -s  and doesn't resolve stage from provider

# Build/Package up the Service
serverless package

# Deploy to AWS
serverless deploy --package ./.serverless --region us-west-2 --stage dev


# Remove deprecation warkings
./serverless.yml
provider.lambdaHashingVersion: 20201221

# Questions & TODOs
1) Do we need the concept of leo system?
2) Convert sdk to promises?  sdk.put, sdk.enrich, sdk.offload, etc...
3) Typescript support, transpile to different dir?
4) Can we remove ${stage} from bot names?
5) Properly register serverless-leo event
6) need to figure out how to remove variableSyntax from serverless
7) serverless-webpack was causing issues with deasync - fix this
8) Support .yaml
9) How do you get Config to the Data Store?


Can you build code once and deploy many while using serverless variables?

sls artifact to only build once https://medium.com/@samnco/serverless-framework-immutable-packaging-how-to-9573ffdd3dd6


    leoStack: ClintTestBus-Bus-1AU1ENWIRG4NO
